--- START OF FILE index.html ---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Yarn Planner Pro | Professional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <style>
    :root {
      --primary: #1a5276;
      --secondary: #1e8449;
      --accent: #f39c12;
      --danger: #cb4335;
      --bg: #f0f3f4;
      --card-bg: #ffffff;
      --text: #2c3e50;
    }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0; padding: 0;
      line-height: 1.3;
    }

    .container { max-width: 1100px; margin: 0 auto; padding: 10px; }
    h2, h3 { color: var(--primary); text-align: center; margin: 8px 0; }
    label { font-size: 10px; font-weight: bold; color: #555; display: block; margin-bottom: 1px; }

    input, select, button {
      width: 100%; padding: 8px; font-size: 16px; 
      margin-bottom: 5px; border: 1px solid #ccc; border-radius: 6px; 
      box-sizing: border-box; background: white;
    }

    @media (min-width: 768px) {
        input, select, button { font-size: 14px; }
    }

    input[type="number"] { -moz-appearance: textfield; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    button { background-color: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; transition: 0.1s; }
    button:active { transform: scale(0.97); }
    .btn-green { background-color: var(--secondary) !important; }
    .btn-red { background-color: var(--danger); }
    .btn-outline { background-color: #e5e8e8; color: var(--text); border: 1px solid #bdc3c7; }

    .card { background: var(--card-bg); padding: 12px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 12px; border: 1px solid #dcdde1; }

    .top-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; padding: 8px; margin-top: 10px; }
    @media (min-width: 768px) { .top-grid { grid-template-columns: repeat(4, 1fr); } }

    .block { border: 2px solid var(--primary); padding: 8px; margin-bottom: 12px; border-radius: 8px; background: #fbfcfc; }
    .block-title { font-weight: bold; margin-bottom: 6px; color: var(--primary); font-size: 14px; display: flex; justify-content: space-between; align-items: center; }

    .row { display: grid; grid-template-columns: 25px 35px 2fr 1fr 1fr 35px 35px; gap: 4px; margin-bottom: 4px; align-items: center; }
    .row-num { font-size: 10px; color: #7f8c8d; font-weight: bold; text-align: center; }

    .seq-btn { background: #5d6d7e; font-size: 10px; padding: 4px; height: 34px; transition: background 0.3s; }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 12px; background: white; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
    th { background: var(--primary); color: white; }
    .total-row { background: #eaeded; font-weight: bold; color: var(--primary); }
    .subtotal-row { background: #f2f4f4; font-weight: bold; font-style: italic; color: #566573; }

    .hidden { display: none !important; }

    @media print {
      @page { size: portrait; margin: 1cm; }
      .no-print, button, .no-print-force, hr, .block, #colourMasterSection, .folder-item-card { display: none !important; }
      
      body { background: white; font-size: 9pt; color: black; }
      .container { max-width: 100%; padding: 0; margin: 0; }
      
      h3 { text-align: left; font-size: 10pt; margin: 10px 0 5px 0; }
      
      .card { 
        box-shadow: none; 
        border: 1px solid #000; 
        margin-bottom: 10px; 
        padding: 5px; 
        width: 100%;
        margin-left: 0;
      }
      
      .top-grid { 
        display: grid !important; 
        grid-template-columns: repeat(3, 1fr) !important; 
        gap: 5px !important;
      }
      
      .top-grid input, .top-grid select { 
        border: none !important; 
        font-size: 9pt !important; 
        background: transparent !important; 
        padding: 0 !important;
        appearance: none;
      }

      table { 
        width: 100% !important;
        margin-left: 0; 
        font-size: 9pt;
      }
      
      th, td { 
        padding: 3px !important; 
        text-align: left !important;
        border: 1px solid #444 !important;
      }
      
      .total-row, .subtotal-row { background: #eee !important; color: black !important; }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- HOME PAGE -->
  <div id="homePage">
    <h2>üßµ Yarn Planner Pro</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;">
        <button class="btn-green" onclick="createNewDesign()">+ Create Design</button>
        <button class="btn-outline" onclick="createNewFolder()">+ Create Folder</button>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:15px;">
        <button class="btn-outline" onclick="exportData()">üíæ Save Entire Data</button>
        <button class="btn-outline" onclick="document.getElementById('importFile').click()">üì• Import Designs</button>
        <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
    </div>
    <div id="folderList"></div>
    <hr>
    <h3>Uncategorized Designs</h3>
    <div id="designList"></div>
  </div>

  <!-- EDITOR PAGE -->
  <div id="editorPage" class="hidden">
    <div class="no-print" style="display:flex; gap:6px;">
      <button class="btn-outline" style="width:70px" onclick="goHome()">Back</button>
      <button class="btn-green" onclick="saveDesign(true)">Save</button>
      <button class="btn-outline" onclick="saveDesign(false)">Save New</button>
      <button class="btn-outline" style="width:70px" onclick="window.print()">Print</button>
    </div>

    <div class="card top-grid">
      <div style="grid-column: span 2;"><label>Design Name</label><input type="text" id="designNameField" placeholder="Enter Design Name"></div>
      <div style="grid-column: span 2;"><label>Folder</label><select id="designFolderSelect" onchange="onFolderChangeInEditor()"></select></div>
      <div><label>Main Count</label>
        <select id="yarnCount" onchange="onYarnChange()">
          <option value="">Select</option>
          <option value="6s">6s</option><option value="10s">10s</option>
          <option value="14s">14s</option><option value="17s">17s</option>
          <option value="26s">26s</option><option value="32s">32s</option>
          <option value="40s">40s</option><option value="60s">60s</option>
          <option value="84s">84s</option><option value="100s">100s</option>
          <option value="2/17s">2/17s</option><option value="2/26s">2/26s</option>
          <option value="2/40s">2/40s</option><option value="2/60s">2/60s</option>
          <option value="2/80s">2/80s</option><option value="33K">33K</option>
          <option value="56K">56K</option><option value="100K">100K</option>
        </select>
      </div>
      <div><label>Length (Haat)</label><input type="number" step="any" inputmode="decimal" id="fabricHaat" value="29"></div>
      <div><label>Reed</label><input type="number" step="any" inputmode="decimal" id="reedValue" oninput="refreshAllRowThreads()"></div>
      <div><label>Shrinkage (In)</label><input type="number" step="any" inputmode="decimal" id="shrinkageInch" oninput="refreshAllRowThreads()"></div>
      <div><label>Than</label><input type="number" step="any" inputmode="decimal" id="thanValue" value="1"></div>
      <div><label>Repeat</label><input type="number" step="any" inputmode="decimal" id="designRepeat" value="1"></div>
      <div><label>Hank Len</label><input type="number" step="any" inputmode="decimal" id="hankLength"></div>
      <div><label>Unit</label><select id="globalUnit" onchange="refreshAllRowThreads()"><option value="inch">Inch</option><option value="cm">CM</option></select></div>
    </div>

    <div id="blocks"></div>
    
    <div class="no-print" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
        <button class="btn-outline" onclick="addBlock('border', 'Border', 1, [], true)">+ Add Border (Top)</button>
        <button class="btn-outline" onclick="addBlock('border', 'Border', 1)">+ Add Border (Bottom)</button>
        <button class="btn-outline" onclick="addBlock('design', 'Main Design', 3)">+ Add Design Block</button>
    </div>

    <button class="no-print" style="margin:15px 0;" onclick="calculate()">Calculate Instruction</button>

    <h3>Weaver Instruction</h3>
    <div id="weaverTable" class="weaver-table-container"></div>
    
    <h3>Dyeing Instruction</h3>
    <div id="dyeTable"></div>

    <div class="no-print" style="margin-top:20px; padding-top:10px; border-top: 1px solid #ccc;">
      <button class="btn-outline" id="toggleColBtn" onclick="toggleColourMaster()">Show Color Master</button>
      <div id="colourMasterSection" class="hidden card" style="margin-top:8px;">
          <div id="colourRows"></div>
          <button class="btn-outline" onclick="addColourRow()">+ Add Color Entry</button>
          <button class="btn-green" id="syncBtn" onclick="saveColours()">Save & Sync Colors Across Folder</button>
      </div>
    </div>
  </div>

  <!-- FOLDER PAGE -->
  <div id="folderPage" class="hidden">
    <div class="no-print" style="display:flex; gap:8px; margin-bottom:15px;">
        <button class="btn-outline" style="width:80px" onclick="goHome()">Back</button>
    </div>
    <h2 id="folderTitle">Folder View</h2>
    <div id="folderContent"></div>
  </div>
</div>

<script>
const YARN_LIB = {
    "6s": { r: 28, h: 2800, s: 4 }, "10s": { r: 36, h: 2900, s: 4 }, 
    "14s": { r: 44, h: 2950, s: 4 }, "17s": { r: 48, h: 2950, s: 4 },
    "26s": { r: 52, h: 3000, s: 6 }, "32s": { r: 56, h: 3000, s: 6 }, 
    "40s": { r: 64, h: 3000, s: 6 }, "60s": { r: 72, h: 3100, s: 8 }, 
    "84s": { r: 84, h: 3200, s: 8 }, "100s": { r: 96, h: 3300, s: 8 },
    "2/17s": { r: 32, h: 2950, s: 6 }, "2/26s": { r: 42, h: 3000, s: 6 }, 
    "2/40s": { r: 48, h: 3000, s: 6 }, "2/60s": { r: 56, h: 3100, s: 6 }, 
    "2/80s": { r: 64, h: 3200, s: 6 }, "33K": { r: 48, h: 3000, s: 6 },
    "56K": { r: 56, h: 3100, s: 6 }, "100K": { r: 72, h: 3300, s: 6 }
};

let activeDesignIdx = null; 
let activeFolderId = null;
let activeCopyTarget = null;
let manualColors = []; // Local colors for uncategorized designs
const STORAGE_KEY = 'app2_locked_v4';

function getDB() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"designs":[], "folders":[], "folderColours":{}}'); }
function saveDB(db) { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

function exportData() {
    const data = localStorage.getItem(STORAGE_KEY);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `YarnPlanner_Backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const json = JSON.parse(e.target.result);
            if (confirm("Replace existing data?")) { localStorage.setItem(STORAGE_KEY, JSON.stringify(json)); loadHome(); }
        } catch (err) { alert("Invalid file."); }
    };
    reader.readAsText(file);
}

function goHome() {
    document.getElementById('homePage').classList.remove('hidden');
    document.getElementById('editorPage').classList.add('hidden');
    document.getElementById('folderPage').classList.add('hidden');
    activeDesignIdx = null; activeFolderId = null; loadHome();
}

function createNewDesign() {
    activeDesignIdx = null;
    activeFolderId = null;
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('folderPage').classList.add('hidden');
    document.getElementById('editorPage').classList.remove('hidden');
    resetEditor();
}

function resetEditor() {
    document.getElementById('blocks').innerHTML = '';
    document.getElementById('weaverTable').innerHTML = '';
    document.getElementById('dyeTable').innerHTML = '';
    document.getElementById('fabricHaat').value = "29";
    document.getElementById('designNameField').value = "";
    document.getElementById('yarnCount').value = "";
    manualColors = [];
    updateFolderDropdown();
    if(activeFolderId) document.getElementById('designFolderSelect').value = activeFolderId;
    addBlock('design', 'Main Design', 3);
    loadColoursInEditor();
}

function onYarnChange() {
    const v = document.getElementById('yarnCount').value;
    if(YARN_LIB[v]) {
        document.getElementById('reedValue').value = YARN_LIB[v].r;
        document.getElementById('hankLength').value = YARN_LIB[v].h;
        document.getElementById('shrinkageInch').value = YARN_LIB[v].s;
        refreshAllRowThreads();
    }
}

function updateRowThreads(input) {
    const row = input.closest('.row');
    const reed = parseFloat(document.getElementById('reedValue').value) || 1;
    const shrinkage = parseFloat(document.getElementById('shrinkageInch').value) || 0;
    const factor = reed + shrinkage;
    const unit = document.getElementById('globalUnit').value;
    const wInp = row.querySelector('.width'), tInp = row.querySelector('.threads');
    if(input.classList.contains('width')) {
        const inch = unit === 'cm' ? (parseFloat(wInp.value)||0)/2.54 : (parseFloat(wInp.value)||0);
        tInp.value = Math.round(inch * factor);
    } else {
        const inch = (parseFloat(tInp.value)||0) / factor;
        wInp.value = unit === 'cm' ? (inch * 2.54).toFixed(2) : inch.toFixed(2);
    }
}
function refreshAllRowThreads() { document.querySelectorAll('.width').forEach(updateRowThreads); }

function createRow(c='', w='', t='') {
    const r = document.createElement('div'); r.className = 'row';
    r.innerHTML = `
        <div class="row-num"></div>
        <button class="seq-btn no-print-force" onclick="copyRowToBottom(this)">Seq</button>
        <select class="color-sel"></select>
        <input class="width" type="number" step="any" inputmode="decimal" placeholder="W" oninput="updateRowThreads(this)" value="${w}">
        <input class="threads" type="number" step="any" inputmode="decimal" placeholder="T" oninput="updateRowThreads(this)" value="${t}">
        <button class="btn-outline no-print-force" onclick="addRowBelow(this)">+</button>
        <button class="btn-red no-print-force" onclick="this.parentElement.remove(); renumberRows();">√ó</button>`;
    fillColDropdown(r.querySelector('.color-sel'), c);
    return r;
}

function renumberRows() { let count = 1; document.querySelectorAll('.row-num').forEach(el => el.innerText = count++); }
function addRowBelow(btn) { btn.closest('.row').after(createRow()); renumberRows(); }

function toggleCopyMode(btn) {
    const container = btn.closest('.block').querySelector('.row-container');
    if (activeCopyTarget === container) {
        activeCopyTarget = null; btn.innerText = "Copy from Design"; btn.classList.remove('btn-green');
    } else {
        document.querySelectorAll('.copy-mode-btn').forEach(b => { b.innerText = "Copy from Design"; b.classList.remove('btn-green'); });
        activeCopyTarget = container; btn.innerText = "Finish Copying"; btn.classList.add('btn-green');
    }
}

function copyRowToBottom(btn) {
    const row = btn.closest('.row'); 
    const c = row.querySelector('.color-sel').value, w = row.querySelector('.width').value, t = row.querySelector('.threads').value;
    if(activeCopyTarget) {
        activeCopyTarget.appendChild(createRow(c, w, t));
        btn.classList.add('btn-green'); setTimeout(() => btn.classList.remove('btn-green'), 300);
    } else {
        row.closest('.row-container').appendChild(createRow(c, w, t));
    }
    renumberRows();
}

function addBlock(type, title, numRows, rowsData = [], atTop = false) {
    const b = document.createElement('div'); b.className = 'block'; b.dataset.type = type;
    let copyBtn = (type === 'border') ? `<button class="btn-outline no-print-force copy-mode-btn" style="width:auto; padding:2px 8px; font-size:10px; margin:0 5px;" onclick="toggleCopyMode(this)">Copy from Design</button>` : '';
    b.innerHTML = `<div class="block-title"><span>${title} ${copyBtn}</span><button class="btn-red no-print-force" style="width:auto; padding:2px 8px;" onclick="removeBlock(this)">√ó</button></div><div class="row-container"></div>`;
    const container = b.querySelector('.row-container');
    if(rowsData.length > 0) rowsData.forEach(rd => container.appendChild(createRow(rd.c, rd.w, rd.t)));
    else for(let i=0; i<numRows; i++) container.appendChild(createRow());
    if(atTop) document.getElementById('blocks').prepend(b); else document.getElementById('blocks').appendChild(b);
    renumberRows();
}

function removeBlock(btn) { const b = btn.closest('.block'); if (activeCopyTarget === b.querySelector('.row-container')) activeCopyTarget = null; b.remove(); renumberRows(); }

function calculate() {
    const repeat = parseFloat(document.getElementById('designRepeat').value) || 1, haat = parseFloat(document.getElementById('fabricHaat').value) || 0, than = parseFloat(document.getElementById('thanValue').value) || 1, dCount = document.getElementById('yarnCount').value;
    let dye = {}, seq = 1, totalDSum = 0, totalBSum = 0, wHtml = `<table><tr><th>Seq</th><th>Colour</th><th>Threads</th></tr>`;
    document.querySelectorAll('.block').forEach(b => {
        const type = b.dataset.type; let blockThreads = 0;
        wHtml += `<tr style="background:#f8f9f9"><td colspan="3"><b>${type.toUpperCase()}</b></td></tr>`;
        b.querySelectorAll('.row').forEach(r => {
            const c = r.querySelector('.color-sel').value.trim(), t = parseFloat(r.querySelector('.threads').value) || 0;
            if(!c || t <= 0) return;
            wHtml += `<tr><td>${seq++}</td><td>${c}</td><td>${t}</td></tr>`;
            if(!dye[c]) dye[c] = { inRepeat: 0, inBorder: 0 };
            if(type === 'design') { dye[c].inRepeat += t; totalDSum += t; } else { dye[c].inBorder += t; totalBSum += t; }
            blockThreads += t;
        });
        wHtml += `<tr class="subtotal-row"><td></td><td>Block Total</td><td>${blockThreads}</td></tr>`;
    });
    const grandTotal = (totalDSum * repeat) + totalBSum; 
    wHtml += `<tr class="total-row"><td>Reed: ${document.getElementById('reedValue').value}</td><td>Drum: ${(grandTotal/(parseFloat(document.getElementById('reedValue').value)||1)).toFixed(2)}</td><td>Threads/Repeat: ${totalDSum}<br>(${totalDSum} √ó ${repeat}) + ${totalBSum} = ${grandTotal}</td></tr></table>`;
    document.getElementById('weaverTable').innerHTML = wHtml;

    let dSumRep = 0, dSumBord = 0, dSumThan = 0, dSumTotal = 0, dSumHanks = 0;
    let dHtml = `<table><tr><th>Colour</th><th>In Repeat</th><th>In Border</th><th>Threads/Than</th><th>Total Threads</th><th>Hanks</th></tr>`;
    for(let c in dye) {
        let yarn = { h: parseFloat(document.getElementById('hankLength').value) || 3000 };
        for (let key in YARN_LIB) { if (c.toLowerCase().startsWith(key.toLowerCase())) { yarn = YARN_LIB[key]; break; } }
        const tpt = (dye[c].inRepeat * repeat) + dye[c].inBorder, tt = tpt * than, hanks = (tt * haat) / yarn.h;
        dHtml += `<tr><td style="text-align:left">${c}</td><td>${Math.round(dye[c].inRepeat)}</td><td>${Math.round(dye[c].inBorder)}</td><td>${Math.round(tpt)}</td><td>${Math.round(tt)}</td><td>${hanks.toFixed(2)}</td></tr>`;
        dSumRep += dye[c].inRepeat; dSumBord += dye[c].inBorder; dSumThan += tpt; dSumTotal += tt; dSumHanks += hanks;
    }
    dHtml += `<tr class="total-row"><td>TOTAL</td><td>${Math.round(dSumRep)}</td><td>${Math.round(dSumBord)}</td><td>${Math.round(dSumThan)}</td><td>${Math.round(dSumTotal)}</td><td>${dSumHanks.toFixed(2)}</td></tr></table>`;
    document.getElementById('dyeTable').innerHTML = dHtml;
}

function saveDesign(isUpdate) {
    const db = getDB(), name = document.getElementById('designNameField').value.trim();
    if(!name) return alert("Name required");
    const config = { yarnCount: document.getElementById('yarnCount').value, fabricHaat: document.getElementById('fabricHaat').value, reedValue: document.getElementById('reedValue').value, shrinkageInch: document.getElementById('shrinkageInch').value, hankLength: document.getElementById('hankLength').value, designRepeat: document.getElementById('designRepeat').value, globalUnit: document.getElementById('globalUnit').value, thanValue: document.getElementById('thanValue').value, manualColors: activeFolderId ? [] : manualColors };
    const blocks = [];
    document.querySelectorAll('.block').forEach(b => {
        const rows = []; b.querySelectorAll('.row').forEach(r => rows.push({ c: r.querySelector('.color-sel').value, w: r.querySelector('.width').value, t: r.querySelector('.threads').value }));
        blocks.push({ type: b.dataset.type, title: b.querySelector('.block-title span').innerText.split(' ')[0], rows });
    });
    const folderId = document.getElementById('designFolderSelect').value;
    if(isUpdate && activeDesignIdx !== null) { db.designs[activeDesignIdx] = { name, folderId, config, blocks }; }
    else { db.designs.push({ name, folderId, config, blocks }); }
    saveDB(db); goHome();
}

function loadHome() {
    const db = getDB(), fList = document.getElementById('folderList'), dList = document.getElementById('designList');
    fList.innerHTML = ''; dList.innerHTML = '';
    db.folders.forEach(f => fList.innerHTML += `<div class="card"><strong>üìÅ ${f.name}</strong><div style="display:flex; gap:5px; margin-top:10px;"><button onclick="viewFolder(${f.id})">Open Folder</button><button class="btn-red" style="width:40px" onclick="deleteFolder(${f.id})">√ó</button></div></div>`);
    db.designs.forEach((d, i) => { if(!d.folderId) dList.innerHTML += `<div class="card"><strong>${d.name}</strong><div style="display:flex; gap:5px; margin-top:10px;"><button onclick="openDesign(${i})">Edit</button><button class="btn-red" style="width:40px" onclick="deleteDesign(${i})">√ó</button></div></div>`; });
}

function viewFolder(id) {
    activeFolderId = id; const db = getDB(), f = db.folders.find(x => x.id == id);
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('folderPage').classList.remove('hidden');
    document.getElementById('folderTitle').innerText = f.name;
    const container = document.getElementById('folderContent');
    container.innerHTML = `<button class="btn-green no-print" style="margin-bottom:15px" onclick="createNewDesignFromFolder(${id})">+ New Design in Folder</button>`;
    db.designs.forEach((d, i) => { if(d.folderId == id) container.innerHTML += `<div class="card folder-item-card"><strong>${d.name}</strong><div style="display:flex; gap:5px; margin-top:8px;"><button class="btn-outline" onclick="openDesign(${i})">Edit</button><button class="btn-red" style="width:40px" onclick="deleteDesign(${i})">√ó</button></div></div>`; });
}

function createNewDesignFromFolder(id) { activeFolderId = id; createNewDesign(); }

function openDesign(idx) {
    const db = getDB(), d = db.designs[idx]; activeDesignIdx = idx; activeFolderId = d.folderId;
    document.getElementById('homePage').classList.add('hidden'); 
    document.getElementById('folderPage').classList.add('hidden');
    document.getElementById('editorPage').classList.remove('hidden');
    updateFolderDropdown(); const c = d.config;
    document.getElementById('designNameField').value = d.name;
    document.getElementById('yarnCount').value = c.yarnCount; 
    document.getElementById('fabricHaat').value = c.fabricHaat;
    document.getElementById('reedValue').value = c.reedValue; 
    document.getElementById('shrinkageInch').value = c.shrinkageInch;
    document.getElementById('thanValue').value = c.thanValue; 
    document.getElementById('hankLength').value = c.hankLength;
    document.getElementById('designRepeat').value = c.designRepeat; 
    document.getElementById('designFolderSelect').value = d.folderId || "";
    manualColors = c.manualColors || [];
    document.getElementById('blocks').innerHTML = ''; 
    d.blocks.forEach(b => addBlock(b.type, b.title, 0, b.rows));
    loadColoursInEditor(); calculate();
}

function onFolderChangeInEditor() { 
    activeFolderId = document.getElementById('designFolderSelect').value; 
    loadColoursInEditor(); 
    document.querySelectorAll('.color-sel').forEach(sel => fillColDropdown(sel, sel.value)); 
}

function loadColoursInEditor() { 
    const db = getDB();
    const colors = activeFolderId ? (db.folderColours[activeFolderId] || []) : manualColors;
    const container = document.getElementById('colourRows'); container.innerHTML = ''; 
    colors.forEach(c => addColourRow(c));
    document.getElementById('syncBtn').innerText = activeFolderId ? "Save & Sync Colors Across Folder" : "Apply Manual Colors";
}

function toggleColourMaster() { const sec = document.getElementById('colourMasterSection'); sec.classList.toggle('hidden'); document.getElementById('toggleColBtn').innerText = sec.classList.contains('hidden') ? "Show Color Master" : "Hide Color Master"; }

function addColourRow(v='') { 
    const d = document.createElement('div'); d.className = 'row'; d.style.gridTemplateColumns = "1fr 45px"; 
    d.innerHTML = `<input class="master-color-input" data-old-val="${v}" value="${v}"><button class="btn-red" onclick="this.parentElement.remove()">√ó</button>`; 
    document.getElementById('colourRows').appendChild(d); 
}

function saveColours() { 
    const db = getDB(), colorInputs = document.querySelectorAll('.master-color-input'), oldToNewMap = {}, newCols = [];
    colorInputs.forEach(i => {
        const oldVal = i.getAttribute('data-old-val'), newVal = i.value.trim();
        if(newVal) { newCols.push(newVal); if(oldVal && oldVal !== newVal) oldToNewMap[oldVal] = newVal; }
    });

    if(activeFolderId) {
        db.folderColours[activeFolderId] = newCols; 
        db.designs.forEach(design => {
            if(design.folderId == activeFolderId) {
                design.blocks.forEach(block => { block.rows.forEach(row => { if(oldToNewMap[row.c]) row.c = oldToNewMap[row.c]; }); });
            }
        });
        saveDB(db); alert("Folder Sync Complete.");
    } else {
        manualColors = newCols; alert("Manual Colors Applied to this design.");
    }
    
    document.querySelectorAll('.color-sel').forEach(sel => {
        const oldVal = sel.value; fillColDropdown(sel, oldToNewMap[oldVal] || oldVal);
    });
    toggleColourMaster();
}

function fillColDropdown(sel, val) { 
    const db = getDB();
    const colors = activeFolderId ? (db.folderColours[activeFolderId] || []) : manualColors; 
    sel.innerHTML = `<option value="">Color</option>`; 
    colors.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`); 
    sel.value = val; 
}

function createNewFolder() { const n = prompt("Folder Name:"); if(n) { const db = getDB(); db.folders.push({ id: Date.now(), name: n }); saveDB(db); loadHome(); } }
function updateFolderDropdown() { const sel = document.getElementById('designFolderSelect'); sel.innerHTML = `<option value="">Uncategorized</option>`; getDB().folders.forEach(f => sel.innerHTML += `<option value="${f.id}">${f.name}</option>`); }
function deleteDesign(i) { if(confirm("Delete Design?")) { const db = getDB(); db.designs.splice(i,1); saveDB(db); loadHome(); if(!document.getElementById('folderPage').classList.contains('hidden')) viewFolder(activeFolderId); } }
function deleteFolder(id) { if(confirm("Delete folder? Designs will become Uncategorized.")) { const db = getDB(); db.folders = db.folders.filter(f => f.id != id); db.designs.forEach(d => { if(d.folderId == id) d.folderId = ""; }); saveDB(db); loadHome(); } }

loadHome();
</script>
</body>
</html>